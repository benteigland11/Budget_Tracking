<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Budget App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font as a nice default */
            padding-top: 1.5rem; /* 24px */
            padding-bottom: 1.5rem; /* 24px */
            background-color: #f8f9fa; /* Light grey background */
        }
        .container {
            max-width: 1140px; /* Larger container for better layout */
        }
        .card {
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* Subtle shadow */
        }
        .card-header {
            background-color: #007bff; /* Primary blue */
            color: white;
            border-bottom: none;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .table-hover tbody tr:hover {
            background-color: #e9ecef;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 350px; /* Fixed height for chart */
            width: 100%;
            max-width: 500px; /* Max width for the chart */
        }
        .summary-stats .card {
            text-align: center;
        }
        .summary-stats h5 {
            font-size: 1.1rem;
            color: #6c757d; /* Muted text color */
        }
        .summary-stats p {
            font-size: 1.75rem;
            font-weight: bold;
        }
        .text-success { color: #28a745 !important; }
        .text-danger { color: #dc3545 !important; }
        .text-info { color: #17a2b8 !important; }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        /* Flash messages styling */
        .flashes { list-style-type: none; padding-left: 0; }
        .flashes li {
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.5rem; /* 8px */
        }
        .flashes .success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .flashes .error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="text-center mb-5">
            <h1 class="display-5 fw-bold">Simple Budget Tracker</h1>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <section class="summary-stats mb-5">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5>Total Income</h5>
                            <p class="text-success">${{ "%.2f"|format(total_income) }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5>Total Expenses</h5>
                            <p class="text-danger">${{ "%.2f"|format(total_expenses) }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5>Balance</h5>
                            <p class="{{ 'text-success' if balance >= 0 else 'text-danger' }}">${{ "%.2f"|format(balance) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h2 class="h5 mb-0">Add New Transaction</h2>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('add_transaction') }}" method="POST">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount</label>
                                <input type="number" step="0.01" class="form-control rounded-pill" id="amount" name="amount" required placeholder="e.g., 50.75">
                            </div>
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <input type="text" class="form-control rounded-pill" id="category" name="category" required placeholder="e.g., Groceries, Salary">
                            </div>
                            <div class="mb-3">
                                <label for="date" class="form-label">Date</label>
                                <input type="date" class="form-control rounded-pill" id="date" name="date" required>
                            </div>
                            <div class="mb-3">
                                <label for="type" class="form-label">Type</label>
                                <select class="form-select rounded-pill" id="type" name="type" required>
                                    <option value="expense" selected>Expense</option>
                                    <option value="income">Income</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 rounded-pill">Add Transaction</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-7 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h2 class="h5 mb-0">Expense Breakdown</h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="expensePieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <section class="mt-4">
            <div class="card">
                 <div class="card-header">
                    <h2 class="h5 mb-0">Transaction History</h2>
                </div>
                <div class="card-body p-0"> <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0"> <thead class="table-light">
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">Category</th>
                                    <th scope="col" class="text-end">Amount</th>
                                    <th scope="col">Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr>
                                    <td>{{ transaction.date }}</td>
                                    <td>{{ transaction.category }}</td>
                                    <td class="text-end">${{ "%.2f"|format(transaction.amount) }}</td>
                                    <td>
                                        <span class="badge rounded-pill bg-{{ 'danger' if transaction.type == 'expense' else 'success' }}">
                                            {{ transaction.type.capitalize() }}
                                        </span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center py-4">No transactions yet. Add one above!</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <footer class="text-center mt-5 mb-3 text-muted">
            <small>Simple Budget App &copy; 2024</small>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script> <script>
        // Set default date for the form to today
        document.addEventListener('DOMContentLoaded', (event) => {
            const dateInput = document.getElementById('date');
            if (dateInput && !dateInput.value) { // Only set if no value is already present (e.g. from server error)
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            }
        });

        // Chart.js configuration
        const ctxPie = document.getElementById('expensePieChart');
        if (ctxPie) {
            const chartLabels = {{ chart_labels|tojson }};
            const chartValues = {{ chart_values|tojson }};

            if (chartLabels.length > 0 && chartValues.length > 0) {
                new Chart(ctxPie, {
                    type: 'pie',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Expenses by Category',
                            data: chartValues,
                            backgroundColor: [ // Distinctive colors
                                'rgba(255, 99, 132, 0.8)',  // Red
                                'rgba(54, 162, 235, 0.8)', // Blue
                                'rgba(255, 206, 86, 0.8)', // Yellow
                                'rgba(75, 192, 192, 0.8)', // Green
                                'rgba(153, 102, 255, 0.8)',// Purple
                                'rgba(255, 159, 64, 0.8)', // Orange
                                'rgba(40, 167, 69, 0.8)',  // Darker Green
                                'rgba(23, 162, 184, 0.8)', // Teal
                                'rgba(108, 117, 125, 0.8)',// Grey
                                'rgba(253, 126, 20, 0.8)'  // Dark Orange
                            ],
                            borderColor: [ // Border colors for slices
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(40, 167, 69, 1)',
                                'rgba(23, 162, 184, 1)',
                                'rgba(108, 117, 125, 1)',
                                'rgba(253, 126, 20, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom', // Better for pie charts
                                labels: {
                                    padding: 20,
                                    font: {
                                        family: 'Inter',
                                        size: 13
                                    }
                                }
                            },
                            tooltip: {
                                bodyFont: {
                                    family: 'Inter'
                                },
                                titleFont: {
                                     family: 'Inter'
                                },
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // Display a message if there's no data for the chart
                const chartContainer = ctxPie.parentElement;
                if (chartContainer) {
                     chartContainer.innerHTML = '<p class="text-center text-muted mt-3">No expense data available to display in chart. Add some expenses!</p>';
                }
            }
        }
    </script>
</body>
</html>
