<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget App - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            padding-top: 1.5rem; 
            padding-bottom: 1.5rem; 
            background-color: #f8f9fa;
        }
        .container { 
            max-width: 1200px;
        }
        .card { 
            border-radius: 0.75rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            margin-bottom: 1.5rem; 
        }
        .card-header { 
            background-color: #007bff; 
            color: white; 
            border-bottom: none; 
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            padding: 0.75rem 1.25rem; 
        }
        .modal-header { /* Style modal headers like card headers */
            background-color: #007bff;
            color: white; 
        }
        .modal-header .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%); /* Make close button white */
        }
        .card-header h2, .card-header h5, .modal-title { 
            margin-bottom: 0;
            font-size: 1.25rem; /* Consistent header size */
        }
        .table-hover tbody tr:hover { 
            background-color: #e9ecef;
        }
        .chart-container { 
            position: relative; 
            margin: 1rem auto;
            height: 380px; 
            width: 100%; 
            max-width: 550px; 
        }
        .summary-stats .card { 
            text-align: center; 
            margin-bottom: 1rem;
        }
        .summary-stats h5 { 
            font-size: 1.0rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        .summary-stats p { 
            font-size: 1.5rem;
            font-weight: bold; 
            margin-bottom: 0;
        }
        .flashes { list-style-type: none; padding-left: 0; margin-bottom: 1rem; }
        .flashes li { padding: 0.75rem 1.25rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: 0.5rem; }
        .flashes .success { color: #0f5132; background-color: #d1e7dd; border-color: #badbcc;}
        .flashes .error { color: #842029; background-color: #f8d7da; border-color: #f5c2c7;}
        .flashes .info { color: #055160; background-color: #cff4fc; border-color: #b6effb;}
        
        .category-list .list-group-item { padding-left: 1.25rem; border-radius: 0.375rem; }
        .category-list .list-group-item ul .list-group-item { padding-left: 2.5rem; background-color: #f8f9fa; border-left: 3px solid #007bff; margin-left: -1.25rem; margin-right: -1.25rem; }
        .delete-btn { font-size: 0.8em; padding: 0.2rem 0.5rem; }
        .form-control, .form-select, .btn { border-radius: 0.375rem; }
        .action-buttons { margin-bottom: 1.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-4">
            <h1 class="display-5 fw-bold">Budget Dashboard</h1>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}<ul class="flashes">{% for cat_flash, msg_flash in messages %}<li class="{{cat_flash}}">{{msg_flash}}</li>{% endfor %}</ul>{% endif %}
        {% endwith %}

        <div class="row action-buttons text-center text-md-start">
            <div class="col-md-auto mb-2 mb-md-0">
                <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill me-2" viewBox="0 0 16 16">
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/>
                    </svg>
                    Add Transaction
                </button>
            </div>
            <div class="col-md-auto">
                <button type="button" class="btn btn-secondary btn-lg" data-bs-toggle="modal" data-bs-target="#manageCategoriesModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-tags-fill me-2" viewBox="0 0 16 16">
                        <path d="M2 2a1 1 0 0 1 1-1h4.586a1 1 0 0 1 .707.293l7 7a1 1 0 0 1 0 1.414l-4.586 4.586a1 1 0 0 1-1.414 0l-7-7A1 1 0 0 1 2 6.586zm3.5 4a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3"/>
                        <path d="M1.293 7.793A1 1 0 0 1 1 7.086V2a1 1 0 0 0-1 1v4.586a1 1 0 0 0 .293.707l7 7a1 1 0 0 0 1.414 0l.043-.043-4.586-4.586z"/>
                    </svg>
                    Manage Categories
                </button>
            </div>
        </div>
        
        <section class="summary-stats mb-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="card"><div class="card-body py-3 px-2"><h5>Total Income</h5><p class="text-success mb-0">${{ "%.2f"|format(total_income) }}</p></div></div>
                </div>
                <div class="col-md-4">
                    <div class="card"><div class="card-body py-3 px-2"><h5>Total Expenses</h5><p class="text-danger mb-0">${{ "%.2f"|format(total_expenses) }}</p></div></div>
                </div>
                <div class="col-md-4">
                    <div class="card"><div class="card-body py-3 px-2"><h5>Current Balance</h5><p class="{{ 'text-success' if balance >= 0 else 'text-danger' }} mb-0">${{ "%.2f"|format(balance) }}</p></div></div>
                </div>
            </div>
        </section>

        <div class="row">
            <div class="col-lg-7 mb-4 mb-lg-0">
                <div class="card">
                    <div class="card-header"><h2 class="h5">Expense Breakdown</h2></div>
                    <div class="card-body"><div class="chart-container"><canvas id="expensePieChart"></canvas></div></div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="card">
                     <div class="card-header"><h2 class="h5">Transaction History</h2></div>
                    <div class="card-body p-0" style="max-height: 450px; overflow-y: auto;"> <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-light sticky-top"> <tr><th>Date</th><th>Category</th><th class="text-end">Amount</th><th>Type</th></tr>
                                </thead>
                                <tbody>
                                {% for t_item in transactions %}
                                    <tr>
                                        <td>{{ t_item.date }}</td>
                                        <td><small>{{ t_item.full_category_name if t_item.full_category_name else 'Uncategorized' }}</small></td>
                                        <td class="text-end">${{ "%.2f"|format(t_item.amount) }}</td>
                                        <td><span class="badge rounded-pill bg-{{'danger' if t_item.type=='expense' else 'success'}}">{{t_item.type.capitalize()}}</span></td>
                                    </tr>
                                {% else %}
                                    <tr><td colspan="4" class="text-center py-4">No transactions yet.</td></tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-5 mb-3 text-muted">
            <small>Advanced Budget App &copy; {{ current_year }}</small>
        </footer>
    </div>

    <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTransactionModalLabel">Add New Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('add_transaction') }}" method="POST" id="addTransactionFormInModal">
                        <div class="mb-3">
                            <label for="modal_amount" class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" id="modal_amount" name="amount" required placeholder="e.g., 50.75">
                        </div>
                        <div class="mb-3">
                            <label for="modal_category_id" class="form-label">Category</label>
                            <select class="form-select" id="modal_category_id" name="category_id" required>
                                <option value="" disabled selected>Select category/subcategory</option>
                                {% for cat_drop in categories_for_dropdown %}
                                <option value="{{ cat_drop.id }}">{{ cat_drop.display_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modal_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="modal_date" name="date" required>
                        </div>
                        <div class="mb-3">
                            <label for="modal_type" class="form-label">Type</label>
                            <select class="form-select" id="modal_type" name="type" required>
                                <option value="expense" selected>Expense</option>
                                <option value="income">Income</option>
                            </select>
                        </div>
                        <div class="mt-4">
                             <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                             <button type="submit" class="btn btn-primary">Save Transaction</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-labelledby="manageCategoriesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl"> <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageCategoriesModalLabel">Manage Categories</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
                    <div class="row">
                        <div class="col-md-5">
                            <h6 class="text-muted mt-2">Add Main Category</h6>
                            <form action="{{ url_for('add_main_category') }}" method="POST" class="mb-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="main_category_name" placeholder="New main category name" required>
                                    <button class="btn btn-success" type="submit">Add Main</button>
                                </div>
                            </form>
                            <hr>
                            <h6 class="text-muted">Add Subcategory</h6>
                            <form action="{{ url_for('add_sub_category') }}" method="POST" class="mb-3">
                                <div class="mb-2">
                                    <label for="modal_parent_category_id" class="form-label small">Parent Main Category:</label>
                                    <select name="parent_category_id" id="modal_parent_category_id" class="form-select form-select-sm" required>
                                        <option value="" disabled selected>Select parent...</option>
                                        {% for main_cat_opt in main_categories_for_sub_add %}
                                        <option value="{{ main_cat_opt.id }}">{{ main_cat_opt.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="sub_category_name" placeholder="New subcategory name" required>
                                    <button class="btn btn-info" type="submit">Add Sub</button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-7">
                            <h6 class="text-muted mt-2">Existing Categories:</h6>
                            <div class="category-list">
                            {% if categories_for_management %}
                                <ul class="list-group">
                                {% for main_cat_manage in categories_for_management %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center fw-bold">
                                        <span>{{ main_cat_manage.name }}</span>
                                        <form action="{{ url_for('delete_category', category_id=main_cat_manage.id) }}" method="POST" 
                                              onsubmit="return confirm('Are you sure you want to delete the MAIN category ' + {{ main_cat_manage.name|tojson|safe }} + '? This requires its subcategories to be deleted first and will uncategorize transactions directly under it.');">
                                            <button type="submit" class="btn btn-danger btn-sm delete-btn">&times;</button>
                                        </form>
                                    </li>
                                    {% if main_cat_manage.sub_categories %}
                                        <ul class="list-group list-group-flush">
                                        {% for sub_cat_manage in main_cat_manage.sub_categories %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <small class="ms-3">{{ sub_cat_manage.name }}</small>
                                                <form action="{{ url_for('delete_category', category_id=sub_cat_manage.id) }}" method="POST" 
                                                      onsubmit="return confirm('Are you sure you want to delete the subcategory ' + {{ sub_cat_manage.name|tojson|safe }} + '? This will uncategorize transactions currently under it.');">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm delete-btn">&times;</button>
                                                </form>
                                            </li>
                                        {% endfor %}
                                        </ul>
                                    {% endif %}
                                {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted">No categories defined yet. Add some!</p>
                            {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date for the transaction form (inside the modal) to today
            const modalDateInput = document.getElementById('modal_date');
            if (modalDateInput && !modalDateInput.value) { 
                const today = new Date();
                modalDateInput.value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            }

            // Chart.js configuration for Expense Pie Chart
            const ctxPie = document.getElementById('expensePieChart');
            if (ctxPie) {
                const chartLabels = {{ chart_labels|tojson|safe }};
                const chartValues = {{ chart_values|tojson|safe }};
                
                if (chartLabels && chartLabels.length > 0 && chartValues && chartValues.length > 0) {
                    new Chart(ctxPie, {
                        type: 'pie',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'Expenses by Category', data: chartValues,
                                backgroundColor: ['rgba(255,99,132,0.8)','rgba(54,162,235,0.8)','rgba(255,206,86,0.8)','rgba(75,192,192,0.8)','rgba(153,102,255,0.8)','rgba(255,159,64,0.8)','rgba(40,167,69,0.8)','rgba(23,162,184,0.8)','rgba(108,117,125,0.8)','rgba(253,126,20,0.8)','rgba(220,53,69,0.8)','rgba(25,135,84,0.8)','rgba(255,193,7,0.8)','rgba(13,110,253,0.8)'],
                                borderColor: ['#FFFFFF'], borderWidth: 1.5
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { padding: 15, font: { family: 'Inter', size: 12 }}},
                                tooltip: {
                                    bodyFont: { family: 'Inter' }, titleFont: { family: 'Inter' },
                                    callbacks: { 
                                        label: function(tooltipItem) {
                                            let label = tooltipItem.label || '';
                                            if (label) { label += ': '; }
                                            if (tooltipItem.parsed !== undefined && tooltipItem.parsed !== null) { 
                                                label += new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(tooltipItem.parsed);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    const chartParent = ctxPie.parentElement;
                    if(chartParent){ chartParent.innerHTML = '<p class="text-center text-muted" style="padding-top: 40%;">No expense data for chart.</p>'; }
                }
            }
        });
    </script>
</body>
</html>
